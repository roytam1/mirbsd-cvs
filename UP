#!/bin/mksh
# $Id$
# sync MirOS CVS repo from primary server to primary anoncvs mirror

if wd=$(readlink -nf .); then
	vd=$(readlink -nf $(dirname $0)/..)
else
	wd=$(pwd)
	cd $(dirname $0)/..
	vd=$(pwd)
fi
cd $vd
p=
a=0
if [[ $1 = -A ]]; then
	a=1
	shift
fi
case $1 {
(q)	p=	;;
(c)	p=-cPv	;;
(C)	p=-c	;;
(v)	p=-v	;;
(*)	p=-Pv	;;
}
[[ -n $1 ]] && shift
sshx="--rsh=ssh -T"
[[ -e $HOME/.etc/anonkey.mirbsd ]] && sshx="$sshx -i $HOME/.etc/anonkey.mirbsd"
set -x
nice rsync -rxlztpgaK --delete --stats --exclude=/ign/ "$sshx" $p "$@" \
    ${CVSROOT:-_anoncvs@herc.mirbsd.org:/cvs}/ $vd
cd $wd
[[ $a = 1 ]] && exec /bin/mksh -c "umount $vd; mount $vd"
exit 0
