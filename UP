#!/usr/bin/env mksh
# $Id$
# sync MirOS CVS repo from primary server to primary anoncvs mirror,
# or (if using -B) from there to a secondary anoncvs mirror.

if wd=$(readlink -nf .); then
	vd=$(readlink -nf $(dirname $0))
else
	wd=$(pwd)
	cd $(dirname $0)
	vd=$(pwd)
fi
cd $vd
p=
a=0
sshx="--rsh=ssh -T"
while :; do
	if [[ $1 = -A ]]; then
		a=1
		shift
	elif [[ $1 = -B ]]; then
		: ${CVSROOT:=anoncvs@anoncvs.mirbsd.org:/cvs}
		shift
	elif [[ $1 = -4 ]]; then
		sshx="$sshx -4"
		shift
	else
		break
	fi
done
case $1 {
(q)	p=	;;
(c)	p=-cPv	;;
(C)	p=-c	;;
(v)	p=-v	;;
(*)	p=-Pv	;;
}
[[ -n $1 || -n $2 ]] && shift
[[ -e $HOME/.etc/anonkey.mirbsd ]] && sshx="$sshx -i $HOME/.etc/anonkey.mirbsd"
set -x
nice rsync -rxlztpgaK --delete --stats --exclude=/ign/ "$sshx" $p "$@" \
    ${CVSROOT:-_anoncvs@herc.mirbsd.org:/cvs}/ $vd
cd $wd
[[ $a = 1 ]] && exec /bin/mksh -c "umount $vd; mount $vd"
exit 0
