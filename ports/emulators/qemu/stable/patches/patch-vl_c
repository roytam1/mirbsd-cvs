$MirOS: ports/emulators/qemu/patches/patch-vl_c,v 1.4 2006/10/02 22:18:35 tg Exp $
--- vl.c.orig	Sun Sep  4 17:11:09 2005
+++ vl.c	Mon Oct  2 21:55:32 2006
@@ -42,7 +42,7 @@
 #include <dirent.h>
 #ifdef _BSD
 #include <sys/stat.h>
-#ifndef __APPLE__
+#if !defined(__APPLE__) && !defined(__OpenBSD__)
 #include <libutil.h>
 #endif
 #else
@@ -503,10 +503,18 @@ int64_t cpu_get_real_ticks(void)
 
 #elif defined(__i386__)
 
+#ifdef __OpenBSD__
+#include <machine/pctr.h>
+#endif
+
 int64_t cpu_get_real_ticks(void)
 {
     int64_t val;
+#ifdef __OpenBSD__
+    val = rdtsc();
+#else
     asm volatile ("rdtsc" : "=A" (val));
+#endif
     return val;
 }
 
@@ -911,13 +919,6 @@ static int start_rtc_timer(void)
     return 0;
 }
 
-#else
-
-static int start_rtc_timer(void)
-{
-    return -1;
-}
-
 #endif /* !defined(__linux__) */
 
 #endif /* !defined(_WIN32) */
@@ -986,7 +987,9 @@ static void init_timers(void)
         } else 
 #endif /* defined(__linux__) */
         {
+#if defined(__linux__)
         use_itimer:
+#endif
             pit_min_timer_count = ((uint64_t)itv.it_interval.tv_usec * 
                                    PIT_FREQ) / 1000000;
         }
@@ -1635,6 +1638,7 @@ static int tun_open(char *ifname, int if
 {
     int fd;
     char *dev;
+#ifndef __OpenBSD__
     struct stat s;
 
     fd = open("/dev/tap", O_RDWR);
@@ -1645,6 +1649,22 @@ static int tun_open(char *ifname, int if
 
     fstat(fd, &s);
     dev = devname(s.st_rdev, S_IFCHR);
+#else
+    char dvn[20];
+    int n;
+
+    dev = dvn;
+    for (n = 0; n < 2147483647; ++n) {
+	snprintf(dvn, sizeof(dvn), "/dev/tun%d", n);
+	if ((fd = open(dvn, O_RDWR)) != -1)
+	    break;
+    }
+    if (fd == -1) {
+	fprintf(stderr, "warning: failed to open /dev/tunN for N = 0 .. 2147483647, no virtual network emulation\n");
+	return -1;
+    }
+    printf("Connected to host network interface: %s\n", dvn);
+#endif
     pstrcpy(ifname, ifname_size, dev);
 
     fcntl(fd, F_SETFL, O_NONBLOCK);
@@ -3048,7 +3068,7 @@ const QEMUOption qemu_options[] = {
     /* temporary options */
     { "pci", 0, QEMU_OPTION_pci },
     { "cirrusvga", 0, QEMU_OPTION_cirrusvga },
-    { NULL },
+    { NULL, 0, 0 },
 };
 
 #if defined (TARGET_I386) && defined(USE_CODE_COPY)
@@ -3185,7 +3205,7 @@ int main(int argc, char **argv)
         serial_devices[i][0] = '\0';
     serial_device_index = 0;
     
-    pstrcpy(parallel_devices[0], sizeof(parallel_devices[0]), "vc");
+    pstrcpy(parallel_devices[0], sizeof(parallel_devices[0]), "null");
     for(i = 1; i < MAX_PARALLEL_PORTS; i++)
         parallel_devices[i][0] = '\0';
     parallel_device_index = 0;
