$MirOS$
--- tcpdump.c.orig	Thu Jan  1 00:00:00 1970
+++ tcpdump.c	Mon Jul  9 19:08:41 2007
@@ -37,7 +37,7 @@ static const char rcsid[] =
  * combined efforts of Van, Steve McCanne and Craig Leres of LBL.
  */
 
-#include <sys/types.h>
+#include <sys/param.h>
 #include <sys/time.h>
 #include <sys/ioctl.h>
 #include <sys/wait.h>
@@ -103,7 +103,7 @@ RETSIGTYPE gotchld(int);
 extern __dead void usage(void);
 
 /* Length of saved portion of packet. */
-int snaplen = 0;
+int snaplen = DEFAULT_SNAPLEN;
 
 struct printer {
 	pcap_handler f;
@@ -131,8 +131,6 @@ static struct printer printers[] = {
 	{ pflog_old_if_print,		DLT_OLD_PFLOG },
 	{ pfsync_if_print,		DLT_PFSYNC },
 	{ ppp_ether_if_print,		DLT_PPP_ETHER },
-	{ ieee802_11_if_print,		DLT_IEEE802_11 },
-	{ ieee802_11_radio_if_print,	DLT_IEEE802_11_RADIO },
 	{ NULL,				0 },
 };
 
@@ -165,8 +163,6 @@ static pcap_t *pd;
 /* Multiple DLT support */
 void		 pcap_list_linktypes(pcap_t *);
 void		 pcap_print_linktype(u_int);
-int		 pcap_datalink_name_to_val(const char *);
-const char	*pcap_datalink_val_to_name(u_int);
 
 const struct pcap_linktype {
 	u_int dlt_id;
@@ -194,36 +190,9 @@ const struct pcap_linktype {
 	{ DLT_PPP_ETHER,	"PPP_ETHER" },
 	{ DLT_IEEE802_11,	"IEEE802_11" },
 	{ DLT_PFLOG,		"PFLOG" },
-	{ DLT_IEEE802_11_RADIO,	"IEEE802_11_RADIO" },
 	{ 0,			NULL }
 };
 
-int
-pcap_datalink_name_to_val(const char *name)
-{
-	int i;
-
-	for (i = 0; pcap_linktypes[i].dlt_name != NULL; i++) {
-		if (strcasecmp(pcap_linktypes[i].dlt_name, name) == 0)
-			return (pcap_linktypes[i].dlt_id);
-	}
-
-	return (-1);
-}
-
-const char *
-pcap_datalink_val_to_name(u_int dlt)
-{
-	int i;
-
-	for (i = 0; pcap_linktypes[i].dlt_name != NULL; i++) {
-		if (pcap_linktypes[i].dlt_id == dlt)
-			return (pcap_linktypes[i].dlt_name);
-	}
-
-	return (NULL);
-}
-
 void
 pcap_print_linktype(u_int dlt)
 {
@@ -235,34 +204,6 @@ pcap_print_linktype(u_int dlt)
 		fprintf(stderr, "<unknown: %u>\n", dlt);
 }
 
-void
-pcap_list_linktypes(pcap_t *p)
-{
-	int fd = p->fd;
-	u_int n;
-
-#define MAXDLT	100
-
-	u_int dltlist[MAXDLT];
-	struct bpf_dltlist dl = {MAXDLT, dltlist};
-
-	if (fd < 0)
-		error("Invalid bpf descriptor");
-
-	if (ioctl(fd, BIOCGDLTLIST, &dl) < 0)
-		err(1, "BIOCGDLTLIST");
-
-	if (dl.bfl_len > MAXDLT)
-		error("Invalid number of linktypes: %u\n", dl.bfl_len);
-
-	fprintf(stderr, "%d link types supported:\n", dl.bfl_len);
-
-	for (n = 0; n < dl.bfl_len; n++) {
-		fprintf(stderr, "\t");
-		pcap_print_linktype(dltlist[n]);
-	}
-}
-
 extern int optind;
 extern int opterr;
 extern char *optarg;
@@ -278,7 +219,6 @@ main(int argc, char **argv)
 	RETSIGTYPE (*oldhandler)(int);
 	u_char *pcap_userdata;
 	char ebuf[PCAP_ERRBUF_SIZE];
-	u_int dlt = (u_int) -1;
 
 	cnt = -1;
 	device = NULL;
@@ -423,13 +363,6 @@ main(int argc, char **argv)
 			}
 			break;
 #endif
-		case 'y':
-			i = pcap_datalink_name_to_val(optarg);
-			if (i < 0)
-				error("invalid data link type: %s", optarg);
-			dlt = (u_int)i;
-			break;
-
 		case 'x':
 			++xflag;
 			break;
@@ -450,18 +383,8 @@ main(int argc, char **argv)
 		}
 
 	if (snaplen == 0) {
-		switch (dlt) {
-		case DLT_IEEE802_11:
-			snaplen = IEEE802_11_SNAPLEN;
-			break;
-		case DLT_IEEE802_11_RADIO:
-			snaplen = IEEE802_11_RADIO_SNAPLEN;
-			break;
-		default:
 			snaplen = DEFAULT_SNAPLEN;
-			break;
 		}
-	}
 
 	if (aflag && nflag)
 		error("-a and -n options are incompatible");
@@ -481,7 +404,7 @@ main(int argc, char **argv)
 			if (device == NULL)
 				error("%s", ebuf);
 		}
-		pd = priv_pcap_live(device, snaplen, !pflag, 1000, ebuf, dlt);
+		pd = priv_pcap_live(device, snaplen, !pflag, 1000, ebuf, 0);
 		if (pd == NULL)
 			error("%s", ebuf);
 
@@ -499,11 +422,6 @@ main(int argc, char **argv)
 		}
 	}
 
-	if (Lflag) {
-		pcap_list_linktypes(pd);
-		exit(0);
-	}
-
 	fcode = priv_pcap_setfilter(pd, Oflag, netmask);
 	/* state: STATE_FILTER */
 	if (fcode == NULL)
@@ -542,9 +460,8 @@ main(int argc, char **argv)
 		/* state: STATE_RUN */
 	}
 	if (RFileName == NULL) {
-		(void)fprintf(stderr, "%s: listening on %s, link-type ",
+		(void)fprintf(stderr, "%s: listening on %s\n",
 		    program_name, device);
-		pcap_print_linktype(pd->linktype);
 		(void)fflush(stderr);
 	}
 
@@ -730,6 +647,6 @@ usage(void)
 	(void)fprintf(stderr,
 "\t\t[-i interface] [-r file] [-s snaplen] [-T type] [-w file]\n");
 	(void)fprintf(stderr,
-"\t\t[-y datalinktype] [expression]\n");
+"\t\t[expression]\n");
 	exit(1);
 }
