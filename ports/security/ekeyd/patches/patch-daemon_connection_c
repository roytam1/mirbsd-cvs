$MirOS$
--- daemon/connection.c.orig	Mon Sep 21 11:20:31 2009
+++ daemon/connection.c	Sat Nov 14 23:19:22 2009
@@ -29,6 +29,10 @@
 #include "connection.h"
 #include "failmodes.h"
 
+#if defined(EKEY_OS_OPENBSD) || defined(EKEY_OS_MIRBSD)
+#define ARC4RANDOM_NONCE
+#endif
+
 /* The minimum number of bytes in a shannon info frame to allow updates */
 #define MIN_SHANNON_SIZE 100
 
@@ -45,6 +49,9 @@ uint8_t default_session_key[32];
  * @param buff The buffer to fill.
  * @param count The length of \a buff.
  */
+#ifdef ARC4RANDOM_NONCE
+#define fill_random arc4random_buf
+#else
 static void 
 fill_random(uint8_t *buff, size_t count)
 {
@@ -68,6 +75,7 @@ fill_random(uint8_t *buff, size_t count)
         syslog(LOG_ERR, "Short read of nonce data (%d/%zd)", rd, count);
     }
 }
+#endif
 
 /** Null packet handler 
  *
@@ -243,6 +251,7 @@ keyreq_pkt_handler(econ_state_t *state, 
 
     /* fill nonce with apropriate data */
     if (state->nonce == NULL) {
+        /* XXX we can use MUCH more than 12 with VERY cheap ARC4RANDOM_NONCE */
         state->nonce_len = 12;
         state->nonce = malloc(state->nonce_len);
     }
