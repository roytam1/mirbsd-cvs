$MirOS: ports/devel/pkgconfig/patches/patch-pkg_c,v 1.3 2008/12/26 15:42:06 tg Exp $
$OpenBSD: patch-pkg_c,v 1.4 2003/09/23 05:59:34 marcm Exp $
--- pkg.c.orig	Wed Jan 16 22:59:26 2008
+++ pkg.c	Fri Nov 20 18:24:13 2009
@@ -41,6 +41,7 @@
 #ifdef HAVE_UNISTD_H
 #include <unistd.h>
 #endif
+#include <stdbool.h>
 #include <stdlib.h>
 #include <ctype.h>
 
@@ -393,7 +394,62 @@ get_package_quiet (const char *name)
   return internal_get_package (name, FALSE, TRUE);
 }
 
+/*
+  If certain directories are present, move them to the end of the list
+  to avoid conflicts.
+*/
 static GSList*
+string_list_fix_local_I_dirs (GSList *list)
+{
+	GSList *iter;
+	char *localbase, *x11base = NULL, *usrlocalbase = NULL;
+	bool found_local = false, found_x11 = false, found_usrlocal = false;
+
+	localbase = g_strdup_printf("-I%s/include", LOCALBASE);
+	if (strcmp(LOCALBASE, X11BASE))
+		x11base = g_strdup_printf("-I%s/include", X11BASE);
+	if (strcmp(LOCALBASE, "/usr/local") && strcmp(X11BASE, "/usr/local"))
+		usrlocalbase = g_strdup_printf("-I%s/include", "/usr/local");
+
+	iter = list;
+	while (iter != NULL) {
+		if (!strcmp(iter->data, localbase)) {
+			debug_spew("List contains %s \"%s\" - "
+			    "moving it to the end\n", (gchar *)"LOCALBASE",
+			    (gchar *)iter->data);
+			found_local = true;
+			iter->data = NULL;
+		} else if (x11base != NULL && !strcmp(iter->data, x11base)) {
+			debug_spew("List contains %s \"%s\" - "
+			    "moving it to the end\n", (gchar *)"X11BASE",
+			    (gchar *)iter->data);
+			found_x11 = true;
+			iter->data = NULL;
+		} else if (usrlocalbase != NULL && !strcmp(iter->data,
+		    usrlocalbase)) {
+			debug_spew("List contains %s \"%s\" - "
+			    "moving it to the end\n", (gchar *)"/usr/local",
+			    (gchar *)iter->data);
+			found_usrlocal = true;
+			iter->data = NULL;
+		}
+		iter = iter->next;
+	}
+
+	if (found_local || found_x11 || found_usrlocal)
+		list = g_slist_remove(list, NULL);
+
+	if (found_local)
+		list = g_slist_append(list, localbase);
+	if (found_x11)
+		list = g_slist_append(list, x11base);
+	if (found_usrlocal)
+		list = g_slist_append(list, usrlocalbase);
+
+	return (list);
+}
+
+static GSList*
 string_list_strip_duplicates (GSList *list)
 {
   GHashTable *table;
@@ -979,6 +1035,8 @@ get_merged (Package *pkg, GetListFunc fu
 
   g_slist_free (dups_list);
   
+  list = string_list_fix_local_I_dirs (list);
+
   retval = string_list_to_string (list);
 
   g_slist_free (list);
