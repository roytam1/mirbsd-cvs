$MirOS$
--- src/zlib.c.orig	Fri Jun  3 18:25:47 2005
+++ src/zlib.c	Sat Sep 18 22:39:44 2010
@@ -20,6 +20,8 @@
 #include "buffer.h"
 #include "pagealign_alloc.h"
 
+__RCSID("$MirOS$");
+
 #if defined (SERVER_SUPPORT) || defined (CLIENT_SUPPORT)
 
 #if HAVE_ZLIB_H
@@ -229,7 +231,7 @@ compress_buffer_input (void *closure, ch
 	   would fetch all the available bytes, and at least one byte.  */
 
 	status = (*cb->buf->input) (cb->buf->closure, bd->text,
-				    need, BUFFER_DATA_SIZE, &nread);
+				    need ? 1 : 0, BUFFER_DATA_SIZE, &nread);
 
 	if (status == -2)
 	    /* Don't try to recover from memory allcoation errors.  */
