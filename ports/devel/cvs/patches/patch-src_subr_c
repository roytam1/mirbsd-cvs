$MirOS: ports/devel/cvs/patches/patch-src_subr_c,v 1.3 2010/09/15 20:57:03 tg Exp $
--- src/subr.c.orig	Sun Oct  2 15:16:59 2005
+++ src/subr.c	Thu Jul 28 15:45:48 2011
@@ -26,6 +26,7 @@
 # include <wchar.h>
 #endif
 
+__RCSID("$MirOS: ports/devel/cvs/patches/patch-src_subr_c,v 1.3 2010/09/15 20:57:03 tg Exp $");
 
 
 extern char *getlogin (void);
@@ -807,6 +808,8 @@ sleep_past (time_t desttime)
     long s;
     long us;
 
+    if (time (&t) > desttime) return;
+
     while (time (&t) <= desttime)
     {
 #ifdef HAVE_GETTIMEOFDAY
@@ -835,6 +838,14 @@ sleep_past (time_t desttime)
 	    (void)nanosleep (&ts, NULL);
 	}
     }
+
+    /* sleep another 20 ms (2 HZ) to avoid races */
+    {
+        struct timespec ts;
+        ts.tv_sec = 0;
+        ts.tv_nsec = 20 * 1000 * 1000;
+        (void)nanosleep (&ts, NULL);
+    }
 }
 
 
@@ -1285,7 +1296,7 @@ format_cmdline (const char *format, ...)
 	    		dellist(&pflist);
 	    		free(b);
 			error (1, 0,
-"internal error:  unknown integer arg size (%d)",
+"internal error:  unknown integer arg size (%zd)",
                                length);
 			break;
 		}
@@ -1328,7 +1339,7 @@ format_cmdline (const char *format, ...)
 	    		dellist(&pflist);
 	    		free(b);
 			error (1, 0,
-"internal error:  unknown floating point arg size (%d)",
+"internal error:  unknown floating point arg size (%zd)",
                                length);
 			break;
 		}
