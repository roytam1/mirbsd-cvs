#!/usr/bin/env mksh
#
# svnup-cvs -- another CVS-to-SVN script
#-
# Copyright (c) 2004
#	Benny Siegert <bsiegert@gmx.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publically perform, modi-
# fy, merge, distribute, sell, give away or sublicence, provided the
# above copyright notices, these terms and the disclaimer are retai-
# ned in all redistributions, or reproduced in accompanying documen-
# tation or other materials provided with binary redistributions.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall an author or
# contributor be held liable for any direct, indirect or other dama-
# ge, however caused, arising in any way out of the usage of covered
# work, even if advised of the possibility of such damage.
#-

if [ $# -ne 2 ] ; then
	echo "Usage: svnup-cvs repository path"
	exit 1
fi

SVN_REPOS=$1
REPOS_PATH=$2

set -e # Abort on error

TMPFILE=$(mktemp -t svn-up.XXXXXXXXXX)

if [ ! -d $REPOS_PATH ] ; then
	echo "===> Creating $REPOS_PATH"
	mkdir -p $REPOS_PATH
fi

if [ ! -d $REPOS_PATH/CVS ] ; then
	echo "===> Checking out the current SVN source"
	svn checkout $SVN_REPOS/current $REPOS_PATH
else
	echo "===> Updating the SVN source"
	cd $REPOS_PATH
	svn update
fi

cd $REPOS_PATH

echo "===> Updating the CVS tree"
DATETIME="$(date)"
DATE="$(date +%Y%m%d)"
cvs -qz3 update -Pd

echo "===> Searching for new and deleted files"
svn status > $TMPFILE

echo "===> Performing CVS repository changes"
grep "^\\?" $TMPFILE | cut -c 8- | xargs svn add
grep "^\\!" $TMPFILE | cut -c 8- | xargs svn delete

echo "===> Committing to SVN"
svn commit -m "Import CVS changes until $DATETIME"

echo "===> Tagging import"
svn copy $SVN_REPOS/current $SVN_REPOS/$DATE -m "Tag CVS from $DATETIME"
