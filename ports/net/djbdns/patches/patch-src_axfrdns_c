$MirOS: ports/net/djbdns/patches/patch-src_axfrdns_c,v 1.3 2016/03/26 17:29:20 tg Exp $
--- src/axfrdns.c.orig	Sun Feb 11 21:11:23 2001
+++ src/axfrdns.c	Thu Aug 11 19:43:58 2016
@@ -5,6 +5,7 @@
 #include "uint32.h"
 #include "uint16.h"
 #include "ip4.h"
+#include "ip6.h"
 #include "tai.h"
 #include "buffer.h"
 #include "timeoutread.h"
@@ -21,6 +22,7 @@
 #include "scan.h"
 #include "qlog.h"
 #include "response.h"
+#include "clientloc.h"
 
 extern int respond(char *,char *,char *);
 
@@ -123,9 +125,8 @@ void get(char *buf,unsigned int len)
   }
 }
 
-char ip[4];
+char ip[16];
 unsigned long port;
-char clientloc[2];
 
 struct tai now;
 char data[32767];
@@ -234,18 +235,7 @@ void doaxfr(char id[2])
   tai_now(&now);
   cdb_init(&c,fdcdb);
 
-  byte_zero(clientloc,2);
-  key[0] = 0;
-  key[1] = '%';
-  byte_copy(key + 2,4,ip);
-  r = cdb_find(&c,key,6);
-  if (!r) r = cdb_find(&c,key,5);
-  if (!r) r = cdb_find(&c,key,4);
-  if (!r) r = cdb_find(&c,key,3);
-  if (!r) r = cdb_find(&c,key,2);
-  if (r == -1) die_cdbread();
-  if (r && (cdb_datalen(&c) == 2))
-    if (cdb_read(&c,clientloc,2,cdb_datapos(&c)) == -1) die_cdbread();
+  if (find_client_loc(ip, &c)) die_cdbread();
 
   cdb_findstart(&c);
   for (;;) {
@@ -328,10 +318,10 @@ int main()
   axfr = env_get("AXFR");
   
   x = env_get("TCPREMOTEIP");
-  if (x && ip4_scan(x,ip))
+  if (x && ip6_scan(x,ip))
     ;
   else
-    byte_zero(ip,4);
+    byte_zero(ip,16);
 
   x = env_get("TCPREMOTEPORT");
   if (!x) x = "0";
@@ -357,7 +347,7 @@ int main()
 
     qlog(ip,port,header,zone,qtype," ");
 
-    if (byte_equal(qtype,2,DNS_T_AXFR)) {
+    if (byte_equal(qtype,2,DNS_T_AXFR) || byte_equal(qtype,2,DNS_T_IXFR)) {
       case_lowerb(zone,zonelen);
       fdcdb = open_read("data.cdb");
       if (fdcdb == -1) die_cdbread();
