$MirOS: ports/audio/mpg123/patches/patch-mpg123_c,v 1.1.7.1 2005/03/18 15:43:03 tg Exp $
$OpenBSD: patch-mpg123.c,v 1.2 2001/04/24 00:48:12 naddy Exp $
--- mpg123.c.orig	Tue Jun 15 20:21:14 1999
+++ mpg123.c	Mon Sep  4 18:41:22 2006
@@ -32,8 +32,11 @@
 #include "buffer.h"
 #include "term.h"
 
+#define	INCLUDE_RCSID
 #include "version.h"
 
+__RCSID("$MirOS$");
+
 static void usage(char *dummy);
 static void long_usage(char *);
 static void print_title(void);
@@ -177,6 +180,9 @@ void init_output(void)
         _exit(0);
       default: /* parent */
         xfermem_init_writer (buffermem);
+	if (xfermem_block(XF_WRITER, buffermem) == XF_CMD_TERMINATE) {
+	    intflag = TRUE;
+	}
         param.outmode = DECODE_BUFFER;
     }
   }
@@ -222,7 +228,6 @@ void shuffle_files(int numfiles)
 {
     int loop, rannum;
 
-    srand(time(NULL));
     if(shuffleord)
       free(shuffleord);
     shuffleord = (int *) malloc((numfiles + 1) * sizeof(int));
@@ -238,7 +243,7 @@ void shuffle_files(int numfiles)
     /* now shuffle them */
     if(numfiles >= 2) {
       for (loop = 0; loop < numfiles; loop++) {
-	rannum = (rand() % (numfiles * 4 - 4)) / 4;
+	rannum = (arc4random() % (numfiles * 4 - 4)) / 4;
         rannum += (rannum >= loop);
 	shuffleord[loop] ^= shuffleord[rannum];
 	shuffleord[rannum] ^= shuffleord[loop];
@@ -306,9 +311,9 @@ char *find_next_file (int argc, char *ar
                 if (line[0]=='\0' || line[0]=='#')
                     continue;
 		if ((listnamedir) && (line[0]!='/') && (line[0]!='\\')){
-                    strcpy (linetmp, listnamedir);
-                    strcat (linetmp, line);
-		    strcpy (line, linetmp);
+                    strlcpy (linetmp, listnamedir, 1024);
+                    strlcat (linetmp, line, 1024);
+		    strlcpy (line, linetmp, 1024);
                 }
                 return (line);
             }
@@ -329,6 +334,7 @@ void init_input (int argc, char *argv[])
 {
     int mallocsize = 0;
     char *tempstr;
+    size_t s;
 
     shuffle_listsize = 0;
 
@@ -344,11 +350,11 @@ void init_input (int argc, char *argv[])
 		exit(1);
 	    }
 	}
-	if (!(shufflist[shuffle_listsize] = (char *) malloc(strlen(tempstr) + 1))) {
+	if (!(shufflist[shuffle_listsize] = (char *) malloc(s = (strlen(tempstr) + 1)))) {
 	    perror("malloc");
 	    exit(1);
 	}
-	strcpy(shufflist[shuffle_listsize], tempstr);
+	strlcpy(shufflist[shuffle_listsize], tempstr, s);
 	shuffle_listsize++;
     }
     if (shuffle_listsize) {
@@ -380,7 +386,7 @@ char *get_next_file(int argc, char **arg
         curfile++;
     }
     else {
-       newfile = shufflist[ rand() % shuffle_listsize ];
+       newfile = shufflist[ arc4random() % shuffle_listsize ];
     }
 
     return newfile;
@@ -477,7 +483,7 @@ topt opts[] = {
     {'t', "test",        0,                  0, &param.outmode, DECODE_TEST},
     {'s', "stdout",      0,       SetOutStdout, &param.outmode, DECODE_FILE},
     {'S', "STDOUT",      0,       SetOutStdout1, &param.outmode, DECODE_AUDIOFILE},
-    {'O', "outfile",     GLO_ARG | GLO_CHAR, SetOutFile, NULL, NULL},
+    {'O', "outfile",     GLO_ARG | GLO_CHAR, SetOutFile, NULL, 0},
     {'c', "check",       0,                  0, &param.checkrange, TRUE},
     {'v', "verbose",     0,        set_verbose, 0,           0},
     {'q', "quiet",       0,                  0, &param.quiet,      TRUE},
@@ -776,6 +782,9 @@ int main(int argc, char *argv[])
 #endif	
 	int init;
 
+	/* Initialise early */
+	(void)arc4random();
+
 #ifdef OS2
         _wildcard(&argc,&argv);
 #endif
@@ -913,18 +922,6 @@ int main(int argc, char *argv[])
 				&dirname, &filename))
 				fprintf(stderr, "\nDirectory: %s", dirname);
 			fprintf(stderr, "\nPlaying MPEG stream from %s ...\n", filename);
-
-#if !defined(GENERIC)
-{
-     const char *term_type;
-         term_type = getenv("TERM");
-         if (!strcmp(term_type,"xterm"))
-         {
-           fprintf(stderr, "\033]0;%s\007", filename);
-         }
-}
-#endif
-
 		}
 
 #if !defined(WIN32) && !defined(GENERIC)
