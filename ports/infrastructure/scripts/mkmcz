#!/bin/mksh
# $MirOS: src/share/misc/licence.template,v 1.24 2008/04/22 11:43:31 tg Rel $
#-
# Copyright (c) 2005, 2006
#	Thorsten Glaser <tg@mirbsd.de>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.

if [[ $1 = -C ]]; then
	cpio=-C
	shift
else
	cpio=
fi
if [[ $1 = -s ]]; then
	CVS=svn
	shift
else
	CVS=cvs
fi
target=$1
repo=$2
tag=
if [[ -n $3 && -n $4 ]]; then
	if [[ $CVS = svn ]]; then
		print -u2 mkmcz: Do not know how to do this
		exit 2
	fi
	tag="-r$4:$3"
elif [[ -z $3 ]]; then
	tag="-r$4"
elif [[ $CVS = svn ]]; then
	[[ -n $3 ]] && tag="-r { $3 }"
else
	tag="-D $3"
fi
if [[ $CVS = svn ]]; then
	CVSARGS="co --non-interactive -q $repo"
else
	CVSARGS="-qd $repo co -PA"
fi

export TZ=UTC
if ! T=$(mktemp -d /tmp/mkmcz.XXXXXXXXXX); then
	print -u2 mkmcz: Cannot mktemp
	exit 1
fi
cd $T
print -r -- - "$CVS $CVSARGS $tag $5"
if ! ( umask 022; exec env CVSUMASK=022 $CVS $CVSARGS "$tag" $5 ); then
	cd /tmp
	rm -rf "$T"
	print -u2 mkmcz: Checkout failed
	exit 1
fi
print -r -- - "mpczar -o '$1' -I CVS -I .svn -r . $cpio"
mpczar -o "$1" -I CVS -I .svn -r . $cpio
rv=$?
cd /tmp
rm -rf "$T"
[[ $rv = 0 ]] || print -u2 mkmcz: Archive creation failed
exit $rv
