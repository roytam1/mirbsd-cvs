#!/bin/mksh
# $MirOS: ports/infrastructure/scripts/update-patches,v 1.6 2008/11/08 23:03:45 tg Exp $
#-
# Copyright (c) 2003, 2004, 2005
#	Thorsten "mirabilos" Glaser <tg@MirBSD.de>
# Based upon code and idea (c) 2000
#	Marc Espie for the OpenBSD project. All rights reserved.
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# Licensor offers the work "AS IS" and WITHOUT WARRANTY of any kind,
# express, or implied, to the maximum extent permitted by applicable
# law, without malicious intent or gross negligence; in no event may
# licensor, an author or contributor be held liable for any indirect
# or other damage, or direct damage except proven a consequence of a
# direct error of said person and intended use of this work, loss or
# other issues arising in any way out of its use, even if advised of
# the possibility of such damage or existence of a nontrivial bug.


# if OS diff not capable enough, require GNU diff
if [[ $NEED_GDIFF = yes ]]; then
	if [[ ! -x $(which gdiff) ]]; then
		exec >&2
		print "Fatal:\tGNU diff (gdiff) required for 'update-patches'"
		print "\tIt may be installed from the textproc/gdiff port."
		exit 1
	fi
	DIFFPROG=$(which gdiff)
	TRANSFORM=cat
	DIFF_FLAGS="-adu --ignore-matching-lines="
	DIFF_FLAGS="${DIFF_FLAGS}\"^--- @@$PATCHORIG	.*\""
	DIFF_FLAGS="${DIFF_FLAGS} --ignore-matching-lines="
	DIFF_FLAGS="${DIFF_FLAGS}\"^+++ @@	.*\""
else
	DIFFPROG=$(which diff)
	TRANSFORM='sed s/[.+]/\\\\&/g'
	tfile=$(print -r -- $PATCHORIG | $TRANSFORM)
	DIFF_FLAGS="-adu -I \"^--- @@$(print -- $tfile)	\""
	DIFF_FLAGS="${DIFF_FLAGS} -I \"^\+\+\+ @@	\""
fi

mkdir -p $PATCHDIR


# Find out all $PATCHORIG files and strip the name to what diff will use
( cd $WRKDIST && find . -type f -name "*${PATCHORIG}" \
    | fgrep -v $DISTORIG | sed -e "s#^./\(.*\)\.${PATCHORIG#.*}\$#\1#" \
) |&

while read -p file; do
	if cmp -s "$WRKDIST/$file" "$WRKDIST/$file$PATCHORIG"; then
		print -r -- "$file and $file$PATCHORIG are identical" >&2
		continue
	fi
	if [[ ! -f $WRKDIST/$file ]]; then
		print -r -- "$file does not exist" >&2
		continue
	fi
	print -r -- "Processing ${file}..." >&2
	# look in patchdir for an existing patchfile matching this
	cd $PATCHDIR
	for i in $PATCH_LIST; do
		# Ignore non-files, or old backup
		[[ ! -f $i || $i = *@(${PATCHORIG}|.rej|~) ]] \
		    && continue

		# Patch found. Is this the one?
		if grep "^--- $file$PATCHORIG" "$i" >/dev/null; then
			accounted="$accounted $i"
			# found it, copy preamble before comparison
			esc="$(print -r -- "$file" | sed -e 's#/#\\/#g')"
			( sed -e "/^--- $esc$PATCHORIG/,\$d" <$i; \
			  cd $WRKDIST && ${DIFFPROG} -adup \
			  ${DIFF_ARGS} "$file$PATCHORIG" "$file" \
			) >"$i.new"
			# did it change ? mark it as changed
			tfile="$(print -r -- "$file" | $TRANSFORM)"
			if eval ${DIFFPROG} "$(print -r -- "${DIFF_FLAGS}" \
			    ${DIFF_ARGS} | sed "s#@@#${tfile}#g")" \
			    "$i" "$i.new" 1>&2; then
				rm "$i.new"
			else
				print -r -- "Patch $i for $file updated" >&2
				mv "$i" "$i$PATCHORIG"
				mv "$i.new" "$i"
				edit="$edit $i"
			fi
			continue 2
		fi
	done

	# Build a sensible name for the new patch file
	patchname=patch-$(print -r -- "$file" | sed -e 's#[/. ]#_#g')
	print -r -- "No patch-* found for $file, creating $patchname" >&2
	( print -r -- '$Mir''OS$'; \
	  cd $WRKDIST && ${DIFFPROG} -adup ${DIFF_ARGS} \
	  "$file$PATCHORIG" "$file" \
	) >$patchname
	edit="$edit $patchname"
	accounted="$accounted $patchname"
done

# Verify all patches accounted for
cd $PATCHDIR
for i in *; do
	[[ ! -f $i || $i = *@(${PATCHORIG}|.rej|~) ]] \
	    && continue
	grep '^\\ No newline at end of file' $i >/dev/null \
	    && print -r -- "*** Patch $i needs manual intervention" >&2
	[[ $accounted != *@($i)* ]] \
	    && print -r -- "*** Patch $i not accounted for" >&2
done

print -r -- $edit
exit 0
