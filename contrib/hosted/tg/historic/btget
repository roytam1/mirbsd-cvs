#!/bin/sh
# $MirBSD: licence.template,v 1.9 2004/03/19 23:25:19 tg Stab $
#-
# Copyright (c) year
#	Thorsten "mirabile" Glaser <x86@ePost.de>
#
# Subject to these terms, everybody who obtained a copy of this work
# is hereby permitted to deal in the work without restriction inclu-
# ding without limitation the rights to use, distribute, sell, modi-
# fy, publically perform, give away, merge or sublicence it provided
# this notice is kept and the authors and contributors are given due
# credit in derivates or accompanying documents.
#
# This work is provided by its developers (authors and contributors)
# "as is" and without any warranties whatsoever, express or implied,
# to the maximum extent permitted by applicable law; in no event may
# developers be held liable for damage caused, directly or indirect-
# ly, but not by a developer's malice intent, even if advised of the
# possibility of such damage.
#-
# Simple shell front-end for bugtorrent

ulimit -n 1024
ulimit -d 131072
ulimit -c 0
if [ -z "$1" ]; then
	echo "Syntax: $0 [-n] {-f <FILE> | [-z] <URL>} [--saveas <file|dir>]"
	exit 1
fi
T=curses
if [ x"$1" = x"-n" ]; then
	T=headless
	shift
fi
if [ x"$1" = x"-z" ]; then
	DO_UNZIP=1
	shift
else
	DO_UNZIP=0
fi
if [ x"$1" = x"-f" ]; then
	shift
	F="$1"; shift
	P="$F"
  else
	U="$1"; shift
	F=$(mktemp /home/pub/BT/torrents/T-XXXXXXXXXX)
	I=$(echo $F|sed s/T-/i-/)
	[ "${BT_UP:-0}" -lt 1 -o "${BT_UP:-0}" -gt 15 ] && BT_UP=2
	P="$F --max_upload_rate $BT_UP"
	cd /home/pub/BT
	echo "Loading to $I from $U" >&2
	echo "cd /home/pub/BT; btget -f $P $@" >$I
	echo "# --unzip=$DO_UNZIP; --url $U" >>$I
	ftp -mo $F "$U" || {
		rm -f $F $I
		exit 1
	}
	echo -n "# " >>$I
	ls -l $F >>$I
fi

if [ x"$DO_UNZIP" = x"1" ]; then
	mv $F ${F}.gz
	gzip -d ${F}.gz || mv ${F}.gz $F
fi

/usr/local/bin/btdownload${T}.py $P "$@"

printf '\r\n\n%s\nThe downloader just worked on was: %s\n' \
	============================================================ "$F"
