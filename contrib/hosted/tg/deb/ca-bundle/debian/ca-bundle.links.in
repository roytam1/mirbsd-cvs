#!/bin/mksh
rcsid='$MirOS$'
#-
# Run this on Debian/sid to generate a list of symlinks
# for OpenSSL 1.0.0+ compatibility of hashed directory.
# The package itself can then be built on etch, still.

cd "$(dirname "$0")"
rm -rf ca-bundle.links.in.tmp ca-bundle.links
[[ $(openssl version) = 'OpenSSL 1'* ]] || exit 1
mkdir ca-bundle.links.in.tmp
cd ca-bundle.links.in.tmp
mksh ../../bsd/ssl.certs.shar || exit 1
set -A files -- *.*

print -r -- "# $rcsid" >OUT
print -r -- "# generated on $(TZ=UTC date)" >>OUT
print -r -- "#-"

for file in "${files[@]}"; do
	if [[ $file != [0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f].+([0-9]) ]]; then
		print -ru2 "Invalid file '$file'"
		exit 1
	fi
	fbase=${file%.*}
	hash0=$(openssl x509 -subject_hash_old -noout -in $file)
	hash1=$(openssl x509 -subject_hash -noout -in $file)
	if [[ $file != "${hash0}."+([0-9]) ]]; then
		print -ru2 "Invalid hash $file expected $hash0"
		exit 1
	fi
	num=0
	while [[ -e $hash1.$num ]]; do
		let num++
	done
	ln -s $file $hash1.$num
	print -r usr/share/ca-bundle/certs/$file \
	    usr/share/ca-bundle/certs/$hash1.$num >>OUT
done

cat >>OUT <<'EOF'
#-
etc/ssl/certs/java/cacerts etc/ia32-java-1.5.0-sun/security/cacerts
etc/ssl/certs/java/cacerts etc/ia32-java-6-sun/security/cacerts
etc/ssl/certs/java/cacerts etc/j2se/1.4/security/cacerts
etc/ssl/certs/java/cacerts etc/java-1.5.0-sun/security/cacerts
etc/ssl/certs/java/cacerts etc/java-6-openjdk/security/cacerts
etc/ssl/certs/java/cacerts etc/java-6-sun/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/j2se/1.4/jre/javaws/cacerts
etc/ssl/certs/java/cacerts usr/lib/j2se/1.4/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.06/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.14/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.15/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.16/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.17/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.18/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.19/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-1.5.0-sun-1.5.0.22/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.06/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.10/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.12/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.13/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.14/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/ia32-java-6-sun-1.6.0.22/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-gcj-4.2-1.5.0.0/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-gcj-4.3-1.5.0.0/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-gcj-4.4/jre/lib/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-gcj-4.5/jre/lib/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.06/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.14/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.15/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.16/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.17/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.18/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.19/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-1.5.0-sun-1.5.0.22/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-cacao/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-openjdk/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.06/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.10/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.12/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.13/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.14/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/lib/jvm/java-6-sun-1.6.0.22/jre/lib/security/cacerts
etc/ssl/certs/java/cacerts usr/share/jxplorer/security/cacerts
usr/share/ca-bundle/ca-certificates.crt etc/apache/ssl.crt/ca-bundle.crt
usr/share/ca-bundle/ca-certificates.crt opt/kde3/share/apps/kssl/ca-bundle.crt
usr/share/ca-bundle/ca-certificates.crt opt/trinity/share/apps/kssl/ca-bundle.crt
usr/share/ca-bundle/ca-certificates.crt usr/lib/kde4/share/kde4/apps/kssl/ca-bundle.crt
usr/share/ca-bundle/ca-certificates.crt usr/share/apps/kssl/ca-bundle.crt
usr/share/ca-bundle/ca-certificates.crt usr/share/gajim/data/other/cacerts.pem
usr/share/ca-bundle/ca-certificates.crt usr/share/sympa/ca-bundle.crt
usr/share/ca-bundle/keystore.jks usr/share/ca-certificates-java/cacerts
usr/share/ca-bundle/ksslcalist etc/kde3/ksslcalist
usr/share/ca-bundle/ksslcalist usr/lib/kde4/etc/kde4/ksslcalist
usr/share/ca-bundle/ksslcalist usr/share/kde4/config/ksslcalist
EOF
mv OUT ../ca-bundle.links
cd ..
rm -rf ca-bundle.links.in.tmp
echo All done.
exit 0
