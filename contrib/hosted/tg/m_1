#!/usr/bin/env mksh
cd /
uid=$(id -u)
typeset -l remh=$1
if [[ -z $remh ]]; then
	print Host empty
	exit 1
fi
if ! fgrep -i "Host $remh" $HOME/.etc/ssh/config >/dev/null 2>&1; then
	print Host not configured: $remh
	exit 1
fi

# kill old one first
set -A x $(ps x|fgrep ssh|fgrep -v grep|fgrep "ssh -fNM ${remh}")
while [[ -n ${x[0]} ]]; do
	kill ${x[0]}
	set -A x $(ps x|fgrep ssh|fgrep -v grep|fgrep "ssh -fNM ${remh}")
done

rm -f /var/run/ssh-agent/$uid/ctl.${remh}

# start new one
while [[ -z ${x[0]} ]]; do
	ssh -fNM "$@" ${remh}
	set -A x $(ps x|fgrep ssh|fgrep -v grep|fgrep "ssh -fNM ${remh}")
done
print ${x[0]} >/var/run/ssh-agent/$uid/pid.${remh}
