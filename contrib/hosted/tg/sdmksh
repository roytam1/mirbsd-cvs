#!/bin/mksh
# $MirOS: contrib/hosted/tg/sdmksh,v 1.1 2012/10/21 16:38:04 tg Exp $
#-
# Copyright © 2012, 2018
#	mirabilos <m@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un‐
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.
#-
# GNU screen-based polyterminal debugging for mksh

sessname=$$
tgshell=$1
[[ -x $tgshell ]] || tgshell=$(whence -p "$tgshell")
if [[ ! -x $tgshell ]]; then
	print -u2 Command not found: "$1"
	exit 1
fi
shift

if ! T=$(mktemp -d /tmp/sdmksh.$sessname.XXXXXXXXXX); then
	print -u2 Could not create temporary directory.
	exit 1
fi

export SDMKSH_PATH="$T/.logpath"
print "sdmksh $sessname started at $(date)" >"$SDMKSH_PATH"

if [[ ! -s $SDMKSH_PATH ]]; then
	print -u2 Could not create logging file.
	rm -rf "$T"
	exit 1
fi

{
	print '#!/bin/mksh -x'
	print 'exec tail -F "$SDMKSH_PATH"'
} >"$T/.runlog"

{
	print '#!/bin/mksh -x'
	print -nr "exec ${tgshell@Q}"
	for i in "$@"; do
		print -nr " ${i@Q}"
	done
	print
} >"$T/.runshell"
chmod +x "$T"/.run*

cat >"$T/.scfg" <<-EOF
	startup_message off
	deflogin off
	shell "/bin/mksh"
	shelltitle -
	defscrollback 16384
	escape ^Oo
	hardstatus alwayslastline "%{wm}O %{kr} %H %{ky} %l %{kg} %D %Y-%m-%d %0c:%s %{=b kb} sdmksh %{=b by} %01L=%=%-w%50L>[%n%f %t]%+w%-1< "
	logfile "sdmkshlog.%n"
	screen -t Log$sessname 0 "$T/.runlog"
	split
	focus down
	screen -t sh$sessname 1 "$T/.runshell"
EOF

screen -m -c "$T/.scfg"

rm -rf "$T"
exit 0
