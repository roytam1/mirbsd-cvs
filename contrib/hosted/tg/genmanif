#!/bin/mksh
# $MirOS: contrib/hosted/tg/genmanif,v 1.3 2014/08/05 08:31:18 tg Exp $
#-
# Copyright © 2014, 2015
#	Thorsten “mirabilos” Glaser <tg@mirbsd.org>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un‐
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# This work is provided “AS IS” and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person’s immediate fault when using the work as intended.

function addarg {
	local x

	for x in $1; do
		[[ -e $x ]] && args+=("$1")
		break
	done
}

set -A args
addarg '.*'
addarg '*'

set -o pipefail
exec >MANIFEST
print ^
find ${args[*]} -print0 | sort -z | grep -v -z \
    -e '^MANIFEST$' \
    -e '^MANIFEST\.asc$' | while IFS= read -r -d ''; do
	if [[ -h $REPLY ]]; then
		dst=$(readlink -- "$REPLY") || return $?
		print -r -- "@ ${REPLY@Q} -> ${dst@Q}"
	elif [[ -f $REPLY ]]; then
		set -A dst -- $(md5sum -b <"$REPLY") || return $?
		print -r -- "$dst ${REPLY@Q}"
	elif [[ ! -d $REPLY ]]; then
		print -ru2 "Unknown entity: ${REPLY@Q}"
	fi
done
(( rv |= $? ))
(( rv )) && print ERRORS OCCURED
(( rv )) && print -u2 E: errors occured
(( rv )) || print v2
exit $rv
