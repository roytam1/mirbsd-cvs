#!/bin/mksh
# $MirOS: src/scripts/xbuild-env.sh,v 1.30 2006/10/15 00:16:49 tg Exp $
#-
# Copyright (c) 2004, 2005, 2006, 2007
#	Thorsten Glaser <tg@mirbsd.de>
#
# Provided that these terms and disclaimer and all copyright notices
# are retained or reproduced in an accompanying document, permission
# is granted to deal in this work without restriction, including un-
# limited rights to use, publicly perform, distribute, sell, modify,
# merge, give away, or sublicence.
#
# Advertising materials mentioning features or use of this work must
# display the following acknowledgement:
#	This product includes material provided by Thorsten Glaser.
#
# This work is provided "AS IS" and WITHOUT WARRANTY of any kind, to
# the utmost extent permitted by applicable law, neither express nor
# implied; without malicious intent or gross negligence. In no event
# may a licensor, author or contributor be held liable for indirect,
# direct, other damage, loss, or other issues arising in any way out
# of dealing in the work, even if advised of the possibility of such
# damage or existence of a defect, except proven that it results out
# of said person's immediate fault when using the work as intended.
#-
# call this with the machine as first parameter and canonical target
# name as second parameter; optionally the machine arch as third.

MACHINE=$1
TARGET=$2

: ${HOSTCC:=/usr/bin/mgcc}

if [[ -z $TARGET && $MACHINE = *-* ]]; then
	TARGET=$MACHINE
	MACHINE=${TARGET%%-*}
fi

[[ -z $MACHINE && -n $TARGET ]] && MACHINE=${TARGET%%-*}

if [[ -z $MACHINE ]]; then
	print -u2 No target or machine given.
	exit 1
fi

case $MACHINE {
(alpha|amd64|hppa|i386|m68k|m88k|powerpc|sparc|sparc64|vax)
	MARCH=$MACHINE ;;
(amiga|hp300|mac68k|mvme68k)
	MARCH=m68k ;;
(luna88k|mvme88k)
	MARCH=m88k ;;
(macppc|mvmeppc)
	MARCH=powerpc ;;
(sgi)
	MARCH=mips ;;
(*)
	[[ -n $3 ]] && MARCH=$3
	if [[ -z $MARCH ]]; then
		print -u2 "Cannot guess machine arch for $MACHINE,"
		print -u2 "target $TARGET - please supply."
		exit 1
	fi
	;;
}

[[ -z $TARGET ]] && TARGET=${MARCH}-unknown-mirbsd$(uname -r)
[[ -z $BSDSRCDIR ]] && BSDSRCDIR=/usr/src
if [[ -z $MKSH ]]; then
	if [[ -x /bin/mksh ]]; then
		MKSH=/bin/mksh
	else
		MKSH="/usr/bin/env mksh"
	fi
fi
export SHELL=$MKSH BINOWN=$(id -un) BINGRP=$(id -gn)
if ! FOO=$($SHELL $BSDSRCDIR/gnu/share/config.sub "$TARGET" 2>/dev/null); then
	print -u2 "Invalid target $TARGET chosen, exiting."
	exit 1
else
	TARGET=$FOO
fi
[[ -z $CROSSDIR ]] && CROSSDIR=${DESTDIR}/usr/cross/${TARGET}
HOST=$(make -f /dev/null ___DISPLAY_MAKEVARS=OStriplet)
[[ -n $CFLAGS ]] || CFLAGS="$(cd $BSDSRCDIR/etc; make ___DISPLAY_MAKEVARS=CFLAGS)"

set -e
set -x

mkdir -p $CROSSDIR/host-tools/{{,$TARGET/}bin,include,lib}
(cd $CROSSDIR/host-tools/$TARGET; ln -sf ../include; ln -sf ../lib)
sed -e 's/[ug]name=[a-z]*//g' \
    -e '/^.set/s/   / uname='$BINOWN' gname='$BINGRP' /' \
    <$BSDSRCDIR/etc/mtree/4.4BSD.dist \
    | mtree -qde -p $CROSSDIR -U

print -r -- "$MACHINE" >$CROSSDIR/T_MACHINE
print -r -- "$MARCH" >$CROSSDIR/T_MACHINE_ARCH
print -r -- "$TARGET" >$CROSSDIR/T_CANON
print -r -- "$HOST" >$CROSSDIR/H_CANON

BUILDLDFLAGS="$LDFLAGS -static"
CROSSLDFLAGS="$CROSSLDFLAGS -static"
[[ -z $CROSSCFLAGS && $TARGET = *-mirbsd* && \
    -s $BSDSRCDIR/etc/etc.${MACHINE}/make.cfg.md ]] && \
    CROSSCFLAGS="$(cat $BSDSRCDIR/etc/etc.${MACHINE}/make.cfg.md \
    $BSDSRCDIR/etc/make.cfg | make -f - ___DISPLAY_MAKEVARS=_DEFCOPTS)"
[[ -z $CROSSCFLAGS ]] && CROSSCFLAGS="-O2 -fhonour-copts"

cat >$CROSSDIR/T_BASEENV <<-EOF
	# generated by \$MirOS: src/scripts/xbuild-env.sh,v 1.30 2006/10/15 00:16:49 tg Exp $
	BINOWN='$BINOWN'
	BINGRP='$BINGRP'
	BSDSRCDIR='$BSDSRCDIR'
	BSDOBJDIR='$CROSSDIR/usr/obj'
	CROSSCFLAGS='$CROSSCFLAGS $CROSSCPPFLAGS'
	CROSSDIR='$CROSSDIR'
	HOST='$HOST'
	MACHINE='$MACHINE'
	MACHINE_ARCH='$MARCH'
	MKSH='$MKSH'
	PATH='$CROSSDIR/host-tools/bin:'\$PATH
	SUDO=
	TARGET='$TARGET'
	TARGET_CC='$CROSSDIR/host-tools/bin/$TARGET-gcc'
	export BINOWN BINGRP CROSSDIR MKSH PATH SUDO
EOF

cat >$CROSSDIR/T_ENV <<-EOF
	# generated by \$MirOS: src/scripts/xbuild-env.sh,v 1.30 2006/10/15 00:16:49 tg Exp $
	AR='$CROSSDIR/host-tools/bin/ar'
	AS='$CROSSDIR/host-tools/bin/as'
	CC='$CROSSDIR/host-tools/bin/$TARGET-gcc'
	CFLAGS='$CROSSCFLAGS $CROSSCPPFLAGS'
	CPP=/usr/bin/cpp
	CPPFLAGS='$CROSSCPPFLAGS'
	CROSS_MODE=yes
	DESTDIR='$CROSSDIR'
	HOSTCC='$HOSTCC'
	HOSTCFLAGS='$CFLAGS -Wno-error'
	HOSTLDFLAGS='$LDFLAGS'
	LD='$CROSSDIR/host-tools/bin/ld'
	LDFLAGS='$CROSSLDFLAGS'
	LORDER=/usr/bin/lorder
	NM='$CROSSDIR/host-tools/bin/nm'
	NOMAN=yes
	NOPIC=yes
	OBJCOPY='$CROSSDIR/host-tools/bin/objcopy'
	OBJDUMP='$CROSSDIR/host-tools/bin/objdump'
	PATH='$CROSSDIR/host-tools/bin:'\$PATH
	RANLIB='$CROSSDIR/host-tools/bin/ranlib'
	SIZE='$CROSSDIR/host-tools/bin/size'
	STRIP='$CROSSDIR/host-tools/bin/strip'
	TARGET_CC='$CROSSDIR/host-tools/bin/$TARGET-gcc'
EOF

cat >$CROSSDIR/T_MAKE <<EOF
#!/bin/mksh
# generated by \$MirOS: src/scripts/xbuild-env.sh,v 1.30 2006/10/15 00:16:49 tg Exp $
exec env \\
	CFLAGS="\${CFLAGS-$CROSSCFLAGS $CROSSCPPFLAGS}" \\
	CPPFLAGS="\${CPPFLAGS-$CROSSCPPFLAGS}" \\
	HOSTCFLAGS="\${HOSTCFLAGS-$CFLAGS -Wno-error}" \\
	LDFLAGS='$(print -r -- $BUILDLDFLAGS | sed s/-static//)' \\
	MACHINE="\${MACHINE-$MACHINE}" \\
	MACHINE_ARCH="\${MACHINE_ARCH-$MARCH}" \\
	OStriplet="\${OStriplet-$HOST}" \\
	GCCHOST="\${GCCHOST-$TARGET}" \\
	GCCTARGET="\${GCCTARGET-$TARGET}" \\
	PATH='$CROSSDIR/host-tools/bin:'\$PATH \\
    make MAKE=\$0 \\
	__objdir='obj.$MACHINE' \\
	BSDSRCDIR='$BSDSRCDIR' \\
	BSDOBJDIR='$CROSSDIR/usr/obj' \\
	HOST='$HOST' \\
	AR='$CROSSDIR/host-tools/bin/ar' \\
	AS='$CROSSDIR/host-tools/bin/as' \\
	CC='$CROSSDIR/host-tools/bin/$TARGET-gcc' \\
	CPP=/usr/bin/cpp \\
	CROSS_MODE=yes \\
	CRTI= \\
	CRTBEGIN= \\
	LIBCRT0= \\
	CRTEND= \\
	CRTN= \\
	DESTDIR='$CROSSDIR' \\
	HOSTCC='$HOSTCC' \\
	HOSTLDFLAGS='$LDFLAGS' \\
	LD='$CROSSDIR/host-tools/bin/ld' \\
	LDSTATIC=-static \\
	LORDER=/usr/bin/lorder \\
	NM='$CROSSDIR/host-tools/bin/nm' \\
	NOMAN=yes \\
	NOPIC=yes \\
	OBJCOPY='$CROSSDIR/host-tools/bin/objcopy' \\
	OBJDUMP='$CROSSDIR/host-tools/bin/objdump' \\
	RANLIB='$CROSSDIR/host-tools/bin/ranlib' \\
	SIZE='$CROSSDIR/host-tools/bin/size' \\
	STRIP='$CROSSDIR/host-tools/bin/strip' \\
	TARGET_CC='$CROSSDIR/host-tools/bin/$TARGET-gcc' \\
    "\$@"
EOF
chmod 755 $CROSSDIR/T_MAKE

[[ -n $NOOBJ ]] || ( cd $BSDSRCDIR; \
    BSDSRCDIR=$BSDSRCDIR \
    BSDOBJDIR=$CROSSDIR/usr/obj \
    OStriplet=$HOST \
    MACHINE=$MACHINE \
    MACHINE_ARCH=$MARCH \
    MAKEOBJDIR=obj.$MACHINE \
    make obj )

set +x
print
print Building on $HOST for $TARGET
exit 0
