#!/bin/ksh
# $MirOS: src/scripts/mnt-cvsroot,v 1.4 2005/05/23 13:14:33 tg Exp $
#-
# Copyright (c) 2005
#	Thorsten "mirabile" Glaser <tg@66h.42h.de>
#
# Licensee is hereby permitted to deal in this work without restric-
# tion, including unlimited rights to use, publicly perform, modify,
# merge, distribute, sell, give away or sublicence, provided all co-
# pyright notices above, these terms and the disclaimer are retained
# in all redistributions or reproduced in accompanying documentation
# or other materials provided with binary redistributions.
#
# Licensor hereby provides this work "AS IS" and WITHOUT WARRANTY of
# any kind, expressed or implied, to the maximum extent permitted by
# applicable law, but with the warranty of being written without ma-
# licious intent or gross negligence; in no event shall licensor, an
# author or contributor be held liable for any damage, direct, indi-
# rect or other, however caused, arising in any way out of the usage
# of this work, even if advised of the possibility of such damage.
#-
# Change CVSROOT of a checked out tree (and save space with it)

me="${0##*/}"
newroot="$1"
if [[ -z $newroot ]]; then
	print -u2 "Syntax: $me newroot [dir [...]]"
	exit 1
fi
shift

[[ -z $1 ]] && exec $SHELL $me "$newroot" .

# realpath(2)ise arguments
set -A arg
let i=0
for name in "$@"; do
	arg[i++]="$(readlink -nf "$name")"
done

if ! T="$(mktemp ${arg[0]}/$me.XXXXXXXXXX)"; then
	print -u2 "$me: fatal: cannot mktemp"
	exit 1
fi

trap 'rm -f "$T"; exit 0' 0
trap 'rm -f "$T"; trap - EXIT; exit 1' 1 2 3 13 15

chmod 664 "$T"
print -r -- "$newroot" >"$T"

let rv=0
find "${arg[@]}" -path \*/CVS/Root |&
while read -p name; do
	if ! rm "$name"; then
		print -u2 "$me: error: cannot rm <$name>"
		exit 1
	fi
	ln -f "$T" "$name" || if ! U="$(mktemp ${arg[0]}/$me.XXXXXXXXXX)"; then
		cp "$T" "$name"
	elif cat "$T" >"$U" && ln -f "$U" "$name"; then
		rm -f "$T"
		T="$U"
	else
		rm -f "$U"
		cp "$T" "$name"
	fi
done

exit 0
