# $MirOS: src/distrib/common/install.i386,v 1.4 2007/06/30 02:40:53 tg Exp $
# $OpenBSD: install.md,v 1.28 2005/04/02 14:34:46 krw Exp $
#
#
# Copyright (c) 1996 The NetBSD Foundation, Inc.
# All rights reserved.
#
# This code is derived from software contributed to The NetBSD Foundation
# by Jason R. Thorpe.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. All advertising materials mentioning features or use of this software
#    must display the following acknowledgement:
#        This product includes software developed by the NetBSD
#        Foundation, Inc. and its contributors.
# 4. Neither the name of The NetBSD Foundation nor the names of its
#    contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE
# LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#
#
# machine dependent section of installation/upgrade script.
#

MDFSTYPE=ntfs
MDFSOPTS=ro
MDTERM=wsvtg
MDXAPERTURE=2
MDSERIAL="pccom com"
ARCH=ARCH

# $1 is the disk to check
md_checkfordisklabel() {
	typeset rval=0

	disklabel -r $1 >/dev/null 2>/tmp/checkfordisklabel

	if grep "disk label corrupted" /tmp/checkfordisklabel; then
		rval=2
	fi >/dev/null 2>&1

	rm -f /tmp/checkfordisklabel
	return $rval
}

md_prep_fdisk() {
	typeset _disk=$1

	ask_yn "Do you want to use *all* of $_disk for MirBSD?"
	if [[ $resp = y ]]; then
		echo -n "Putting all of $_disk into an active MirBSD MBR partition (type 27)..."
		fdisk -ef /.nex ${_disk} <<__EOT >/dev/null
r
u
w
q
__EOT
		echo "done."
		return
	fi

	# Manually configure the MBR.
	cat <<__EOT

You will now create a single MBR partition to contain the disklabel. This
partition must have an id of 27; must *NOT* overlap other partitions; and must
be marked as the only active partition. You can create other MBR partitions,
primary or extended ones, to contain the filesystems, but these must *NOT* be
of type 27, A6, A5 or A9. It is recommended they be of type DB (CP/M-86), and
they are only used to mark the space as USED for other operating systems that
still need MBR partitions. BSD exclusively uses the data in the disklabel to
determine where filesystems are, and uses the MBR partition exclusively to
determine where on the disk the disklabel is positioned.

The 'manual' command describes all the fdisk commands in detail.

$(fdisk ${_disk})
__EOT
	fdisk -e ${_disk}

	cat <<__EOT
Here is the partition information you chose:

$(fdisk ${_disk})
__EOT
}

md_prep_disklabel() {
	typeset _disk=$1

	md_prep_fdisk $_disk

	cat <<__EOT

You will now create an MirBSD disklabel inside the MirBSD MBR partition.
The disklabel defines how MirBSD splits up the whole disc into slices
in which filesystems and swap space are created and other operating
systems' filesystems are mapped.

The offsets used in the disklabel are ABSOLUTE, i.e. relative to the
start of the disk, NOT the start of the MirBSD MBR partition. If you
have created a split space, i.e. one partition of type 27 and one or
more partitions of type (e.g.) DB, use b<return>0<return>*<return>
to enable using the entire disk for MirBSD. Be sure to create slices
mapping all other operating systems' filesystems to not overwrite them.

__EOT

	md_checkfordisklabel $_disk
	case $? in
	2)	echo "WARNING: Label on disk $_disk is corrupted. You will be repairing it.\n"
		;;
	esac

	disklabel -W $_disk >/dev/null 2>&1
	disklabel -f /tmp/fstab.$_disk -E $_disk
}

md_congrats() {
}
