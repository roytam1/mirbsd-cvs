#!/bin/mksh
# $MirSecuCron: etc_weekly 0.0 0000/00/00 00:00:00 root Backup $
# $MirOS: src/etc/weekly,v 1.14 2015/10/06 15:05:44 tg Exp $
# $OpenBSD: weekly,v 1.14 2003/06/30 22:04:57 avsm Exp $

umask 022
export LC_ALL=C PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/libexec:/usr/local/bin:/usr/mpkg/bin
cd /

print RUNTIME=$(date +%J)

if [ -f /etc/weekly.local ]; then
	echo ""
	echo "Running weekly.local:"
	. /etc/weekly.local
fi

echo ""
if [ -f /var/db/locate.database ]; then
	TMP=$(mktemp /var/db/locate.database.XXXXXXXXXX)
	if [ $? -eq 0 ]; then
		trap 'rm -f $TMP; exit 1' 0 1 15
		echo "Rebuilding locate database:"
		UPDATEDB="/usr/libexec/locate.updatedb"
		echo "${UPDATEDB} --fcodes=- --tmpdir=${TMPDIR:-/var/tmp}" | \
		    nice -5 su -m nobody 2>/dev/null 1>$TMP
		if [ -s "$TMP" ]; then
			chmod 444 $TMP
			chown root:wheel $TMP
			mv -f $TMP /var/db/locate.database
		else
			echo "Not installing locate database; zero size"
		fi
	else
		echo "Not rebuilding locate database; can't create temp file"
	fi
else
	echo "Not rebuilding locate database; no /var/db/locate.database"
fi

echo ""
echo "Rebuilding whatis databases:"
makewhatis
