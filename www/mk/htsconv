# $MirOS: www/mk/htsconv,v 1.21 2008/03/22 23:44:45 tg Exp $
#-
# This file is part of the website of The MirOS Project, which is
# copyrighted material, please read the LICENCE file for details.

mws__pagename=
mws__header=
mws__rss=
mws__difftag=MBSD_HTSCONV_GENDATE_TAG_31702
unset mws__relpath || true

function mws_setname {
	mws__pagename=$2
	# change index to mark $1
}

function mws_setrss {
	mws__rss="\\
 <link rel=\"alternate\" type=\"application/rss+xml\" title=\"RSS\" href=\"$1\" />"
	# this is for not doing the newline when no RSS is applicable
}

function mws_subdir {
	integer i=$1
	mws__relpath=
	while (( i-- )); do
		mws__relpath=../$mws__relpath
	done
}

function mws_putheader {
	local rcsid=$1
#DEPEND mk/tmpl.pre
	mws__content <"$TOP"/mk/tmpl.pre
	mws__header="<p class=\"rcsdiv\">Generated <!-- $mws__difftag --> on"
	mws__header="$mws__header <span class=\"rcsid\">$(TZ=UTC date +'%F %T')</span>"
	mws__header="$mws__header"' by <span class="rcsid">$MirOS: www/mk/htsconv,v 1.21 2008/03/22 23:44:45 tg Exp $</span>'
	[[ -n $rcsid ]] && mws__header="$mws__header from <span class=\"rcsid\">$rcsid</span>"
	mws__header="$mws__header</p>"
}

function mws_moveifchange {
	if [[ $1 = -k ]]; then
		keep=1
		shift
	else
		keep=0
	fi
	[[ -e $1 && -e $2 ]] || ls -l "$1" "$2" 2>&1 | sed 's/^/！/' >&2
	[[ -e $1 ]] && if [[ -e $2 ]] && \
	    diff -waqI "$mws__difftag" "$1" "$2" >/dev/null 2>&1; then
		[[ $keep = 1 ]] || rm -f "$1"
	else
		if [[ $keep = 1 ]]; then
			cp -f "$1" "$2"
		else
			mv -f "$1" "$2"
		fi
	fi
	#touch "$2"
	return 0
}

function mws_putfooter {
#DEPEND mk/tmpl.post
	mws_content <"$TOP"/mk/tmpl.post
}

function mws_content {
	if [[ -z $mws__header ]]; then
		print -u2 Internal error: mws_putheader not called!
		exit 1
	fi
	mws__content "$@"
}

function mws__content {
	sed \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(DOCS\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PAPERS\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PSD\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(SMM\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(USD\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)/[Ss][Pp][Aa][Rr][Cc])<a href="@@RELPATH@@htman/sparc/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)/[Ii]386)<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e "s@@RELPATH@@$mws__relpathg" \
	    -e "s@@HEADER@@$mws__headerg" \
	    -e "s@@RSS@@$mws__rssg"
}

function mws_push {
	for param in _pagename _relpath; do
		eval mws__push_$param=\$mws_$param
	done
}

function mws_pop {
	for param in _pagename _relpath; do
		eval mws_$param=\$mws__push_$param
	done
}
