rcsid_htsconv='$MirOS: www/mk/htsconv,v 1.30 2008/12/04 20:27:14 tg Exp $'
#-
# This file is part of the website of The MirOS Project, which is
# copyrighted material, please read the LICENCE file for details.

mws__pagename=
mws__header=
mws__rss=
mws__difftag=MBSD_HTSCONV_GENDATE_TAG_7567
unset mws__abspath
unset mws__relpath

function mws_setname {
	mws__pagename=$2
	# change index to mark $1
}

function mws_setrss {
	mws__rss="\\
 <link rel=\"alternate\" type=\"application/rss+xml\" title=\"RSS\" href=\"$1\" />"
	# this is for not doing the newline when no RSS is applicable
}

function mws_subdir {
	if [[ $1 = - ]]; then
		mws__relpath=$mws__abspath/
		return
	fi
	integer i=$1
	mws__relpath=
	while (( i-- )); do
		mws__relpath=../$mws__relpath
	done
}

function mws_putheader {
	local rcsid=$1
	mws__content <<-EOF
		<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
		 "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head>
		 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
		 <meta name="MSSmartTagsPreventParsing" content="TRUE" />
		 <link rel="stylesheet" type="text/css" href="@@RELPATH@@vstyle.css" />
		 <link rel="apple-touch-icon" href="@@RELPATH@@pics/blumenkohl.png" />
		 <meta name="author" content="Thorsten Glaser" />
		 <meta name="copyright" content="All rights reserved. Redistribution except for scientific and educational uses strictly prohibited. Unmodified redistribution with no endorsement permitted." />
		 <meta name="owner" content="The MirOS Project and The MirPorts Framework" />
		 <meta name="licence" content="see the source files in CVSWEB for details" />
		 <title>MirOS: $mws__pagename</title>
		 <meta name="robots" content="index, follow" />@@RSS@@
		 <!--
		  This is copyrighted material. For the full licence text, see the file
		  LICENCE in the current directory. In no event may text from this page
		  be simply copied into another work covered by an unfree (or otherwise
		  mismatching) licence, such as the GNU Free Documentation License.
		 -->
		</head><body>
		<div class="index">
		 <ul class="lv1">
		<li><a href="@@RELPATH@@main.htm">Main</a><ul class="lv2">
		<li><a href="@@RELPATH@@wlog-10.htm">Weblog</a> for #10</li>
		<li><a href="@@RELPATH@@tags.htm">Tag Cloud</a></li>
		<li><a href="@@RELPATH@@news.htm">Old News</a> &amp;
		 <a href="@@RELPATH@@oldnews.htm#owlog">WLog</a></li>
		</ul></li>
		<li><a href="@@RELPATH@@about.htm">About</a></li>
		<!-- these are not in a usable state
		<li><a href="@@RELPATH@@docs.htm">Documentation</a></li>
		<li><a href="@@RELPATH@@faq.htm">FAQ</a></li>
		-->
		<li class="spacer"><a href="@@RELPATH@@getting.htm">Download</a></li>
		<li><a href="@@RELPATH@@rss.htm">RSS &amp; Lists</a></li>
		<li><a href="@@RELPATH@@irc.htm">IRC</a></li>
		<li><a href="@@RELPATH@@projects.htm">Project Ideas</a></li>
		<li><a href="@@RELPATH@@danke.htm">Donate</a></li>
		<li>Manpages<ul class="lv2">
		<li><a href="@@RELPATH@@htman/i386/">i386</a></li>
		<li><a href="@@RELPATH@@htman/sparc/">sparc</a></li>
		</ul></li>
		<li><a href="@@RELPATH@@ports.htm">MirPorts</a> Framework</li>
		<li>Subprojects<ul class="lv2">
		<li><a href="@@RELPATH@@jupp.htm">jupp</a> Editor</li>
		<li><a href="@@RELPATH@@mksh.htm">mksh</a> Shell</li>
		</ul></li>
		 </ul>
		</div>
		<div class="content">
	EOF
	mws__header="<p class=\"rcsdiv\">Generated <!-- $mws__difftag --> on"
	mws__header="$mws__header <span class=\"rcsid\">$(date +'%F %T')</span>"
	mws__header="$mws__header by <span class=\"rcsid\">$rcsid_htsconv</span>"
	for x in "$rcsid_parser" "$rcsid_inc2htm" "$rcsid_inc2rss"; do
		[[ -n $x ]] || continue
		mws__header="$mws__header and <span class=\"rcsid\">$x</span>"
	done
	for x in "$rcsid_cfg" "$rcsid"; do
		[[ -n $x ]] || continue
		mws__header="$mws__header from <span class=\"rcsid\">$x</span>"
	done
	for x in "${rcsid_db[@]}"; do
		[[ -n $x ]] || continue
		mws__header="$mws__header and <span class=\"rcsid\">$x</span>"
	done
	mws__header="$mws__header</p>"
}

function mws_moveifchange {
	if [[ $1 = -k ]]; then
		keep=1
		shift
	else
		keep=0
	fi
	[[ -e $1 && -e $2 ]] || ls -l "$1" "$2" 2>&1 | sed 's/^/！/' >&2
	[[ -e $1 ]] && if [[ -e $2 ]] && \
	    diff -waqI "$mws__difftag" "$1" "$2" >/dev/null 2>&1; then
		[[ $keep = 1 ]] || rm -f "$1"
	else
		if [[ $keep = 1 ]]; then
			cp -f "$1" "$2"
		else
			mv -f "$1" "$2"
		fi
	fi
	#touch "$2"
	return 0
}

function mws_putfooter {
	mws_content <<-'EOF'
		</div>
		<div class="heading">
		 <a href="@@RELPATH@@main.htm"><img class="hdrlnks"
		  src="@@RELPATH@@pics/logo-grey.png" alt="MirOS Logo" /></a>
		</div>
		<div class="footer"><p>• <a
		 href="http://validator.w3.org/check/referer">Valid HTML!</a> • <a
		 href="mailto:miros-discuss@mirbsd.org">eMail</a> contact to the
		 MirOS Project •</p>
		 @@HEADER@@
		</div>
		</body></html>
	EOF
}

function mws_content {
	if [[ -z $mws__header ]]; then
		print -u2 Internal error: mws_putheader not called!
		exit 1
	fi
	mws__content "$@"
}

function mws__content {
	sed \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(DOCS\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PAPERS\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PSD\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(SMM\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(USD\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)/[Ss][Pp][Aa][Rr][Cc])<a href="@@RELPATH@@htman/sparc/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)/[Ii]386)<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\))<a href="@@RELPATH@@htman/i386/man\2/\1.htm">&</a>g' \
	    -e "s@@ABSPATH@@$mws__abspathg" \
	    -e "s@@RELPATH@@$mws__relpathg" \
	    -e "s@@HEADER@@$mws__headerg" \
	    -e "s@@RSS@@$mws__rssg"
}

function mws_push {
	for param in _pagename _relpath; do
		eval mws__push_$param=\$mws_$param
	done
}

function mws_pop {
	for param in _pagename _relpath; do
		eval mws_$param=\$mws__push_$param
	done
}
