# $MirOS: www/mk/htsconv,v 1.7 2007/10/02 18:55:01 tg Exp $
#-
# This file is part of the website of The MirOS Project, which is
# copyrighted material, please read the LICENCE file for details.

mws__pagename=
mws__difftag=MBSD_HTSCONV_GENDATE_TAG_21151
unset mws__relpath || :

function mws_setname {
	mws__pagename=$2
	# change index to mark $1
}

function mws_subdir {
	integer i=$1
	mws__relpath=
	while (( i-- )); do
		mws__relpath=../$mws__relpath
	done
}

function mws_putheader {
	local rcsid=$1
#DEPEND mk/tmpl.pre
	mws_content <"$TOP"/mk/tmpl.pre
	print -nr "<small class=\"rcsdiv\">Generated <!-- $mws__difftag --> on"
	print -nr " <span class=\"rcsid\">$(TZ=UTC date +'%F %T')</span>"
	print -nr ' by <span class="rcsid">$MirOS: www/mk/htsconv,v 1.7 2007/10/02 18:55:01 tg Exp $</span>'
	[[ -n $rcsid ]] && print -nr " from <span class=\"rcsid\">$rcsid</span>"
	print '</small>\n'
}

function mws_moveifchange {
	[[ -e $1 && -e $2 ]] || ls -l "$1" "$2" 2>&1 | sed 's/^/！/' >&2
	[[ -e $1 ]] && if [[ -e $2 ]] && \
	    diff -waqI "$mws__difftag" "$1" "$2" >/dev/null 2>&1; then
		rm -f "$1"
	else
		mv -f "$1" "$2"
	fi
	#touch "$2"
	return 0
}

function mws_putfooter {
#DEPEND mk/tmpl.post
	mws_content <"$TOP"/mk/tmpl.post
}

function mws_content {
	sed \
	    -e "s@@RELPATH@@$mws__relpathg" \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(DOCS\))<a href="/htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PAPERS\))<a href="/htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(PSD\))<a href="/htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(SMM\))<a href="/htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\(USD\))<a href="/htman/i386/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)/sparc)<a href="/htman/sparc/man\2/\1.htm">&</a>g' \
	    -e 's\([0-9A-z][-.,0-9A-z]*\)(\([1-9]\)[/0-9A-Za-z]*)<a href="/htman/i386/man\2/\1.htm">&</a>g'
}

function mws_push {
	for param in _pagename _relpath; do
		eval mws__push_$param=\$mws_$param
	done
}

function mws_pop {
	for param in _pagename _relpath; do
		eval mws_$param=\$mws__push_$param
	done
}
