# $MirOS: www/mk/inc2rss,v 1.10 2008/05/03 01:34:22 tg Exp $
#-
# This file is part of the website of The MirOS Project, which is
# copyrighted material, please read the LICENCE file for details.

integer maxentries=25
DATE_RSS="+%a, %d %b %Y %H:%M:%S %z"
name=$1

. "$TOP/data/$name.cfg"

#DEPEND mk/parser
. "$TOP"/mk/parser

#DEPEND mk/common
. "$TOP"/mk/common

#DEPEND mk/htsconv
. "$TOP"/mk/htsconv

mws__header="<!-- RSS mode -->"
mws__abspath=http://www.mirbsd.org

function rss_putheader {
	#lastchanged=$(date -r $(stat -f "%m" "$TOP/data/$name.inc") "$DATE_RSS")
	lastchanged=$(date "$DATE_RSS")
	sed \
	    -e "s@@TITLE@@$ptitle" \
	    -e "s@@NAME@@$pname" \
	    -e "s@@URI@@$mws__abspath/$1" \
	    -e "s@@DATE@@$lastchanged" \
	    <"$TOP/mk/rss-tmpl.pre"
}

function rss_putfooter {
	cat "$TOP/mk/rss-tmpl.post"
}

function rss_output {
	integer ent=$1
	eid=$2
	rpath=$3
	efe="${mws__abspath}${rpath}${name}_${eid}.htm#$eid"
	pubdate=$(date -r ${ei_date[ent]} "$DATE_RSS")
	if [[ -n ${e_title[ent]} ]]; then
		title="${e_title[ent]}"
	else
		title="${e_date[ent]}${e_author[ent]+ by }${e_author[ent]}"
	fi
	if [[ ${e_language[ent]} = +([A-Za-z0-9-]) ]]; then
		xmllang=" xml:lang=\"${e_language[ent]}\""
		rss3lang="<language>${e_language[ent]}</language>"
	else
		xmllang=
		rss3lang=
	fi
	# we use $xmllang: RSS 2.0 doesn’t allow the language tag inside
	# items, just as channel tag (and Benny’s template doesn’t even
	# use it but dc:language instead)
	cat <<-EOF
		<item$xmllang>
		<title>$title</title>
		<pubDate>$pubdate</pubDate>
		<link>$efe</link>
		<guid isPermaLink="false">tag:mirbsd.org:$name:$eid</guid>
	EOF
	if [[ -n ${e_author[ent]} ]]; then
		eauthor=${e_author[ent]}
		[[ $eauthor = *@ ]] && eauthor="${eauthor}mirbsd.org"
		[[ $eauthor = *\(*\)* ]] || eauthor="$eauthor (MirOS Developer)"
		print "<author>${eauthor}</author>\n"
	fi
	print "<description>"
	mws_content <<<"${e_body[ent]%%@(<!-- RSS stop -->)*}" | \
	    sed -e 's&\&amp;g' -e 's<\&lt;g' -e 's>\&gt;g'
	print "</description></item>"
}

print -r -- ${name}.rss
mws_setname $whoami "$pname"
mws_subdir -
rss_putheader "${name}.rss" >${name}.rss~

integer i='entries - 1'
integer last='entries < maxentries ? 0 : entries - maxentries'
while (( i >= last )); do
	eid=$(uri_escape "${e_id[i]}")
	rss_output $i $eid "/permalinks/" >>${name}.rss~
	let i--
done

rss_putfooter >>${name}.rss~
mws_moveifchange ${name}.rss~ ${name}.rss
exit 0
