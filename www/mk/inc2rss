# $MirOS: www/mk/inc2rss,v 1.5 2008/03/10 14:51:58 tg Exp $
#-
# This file is part of the website of The MirOS Project, which is
# copyrighted material, please read the LICENCE file for details.

integer maxentries=25
DATE_RSS="+%a, %d %b %Y %H:%M:%S %z"
name=$1

. "$TOP/data/$name.cfg"

#DEPEND mk/parser
. "$TOP"/mk/parser

#DEPEND mk/common
. "$TOP"/mk/common

#DEPEND mk/htsconv
. "$TOP"/mk/htsconv

mws__header="<!-- RSS mode -->"

function rss_putheader {
	#lastchanged=$(date -r $(stat -f "%m" "$TOP/data/$name.inc") "+%a, %d %b %Y %H:%M:%S %z")
	lastchanged=$(date "$DATE_RSS")
	sed -e "
		s@@TITLE@@$ptitle
		s@@NAME@@$pname
		s@@DATE@@$lastchanged
	" < "$TOP/mk/rss-tmpl.pre"
}

function rss_putfooter {
	cat "$TOP/mk/rss-tmpl.post"
}

function rss_output {
	integer ent=$1
	eid=$2
	rpath=$3
	efe="${rpath}${name}_${eid}.htm#$eid"
	pubdate=$(date -r ${ei_date[ent]} "$DATE_RSS")
	if [[ -n ${e_title[ent]} ]]; then
		title="${e_title[ent]}"
	else
		title="${e_date[ent]}${e_author[ent]+ by }${e_author[ent]}"
	fi
	if [[ ${e_language[ent]} = +([A-Za-z-]) ]]; then
		xmllang=" xml:lang=\"${e_language[ent]}\""
		rss3lang="<language>${e_language[ent]}</language>"
	else
		xmllang=
		rss3lang=
	fi
	# we use $xmllang: RSS 2.0 doesn’t allow the language tag inside
	# items, just as channel tag (and Benny’s template doesn’t even
	# use it but dc:language instead)
	cat <<-EOF
		<item$xmllang>
		<title>$title</title>
		<pubDate>$pubdate</pubDate>
		<link>$efe</link>
		<guid isPermaLink="false">tag:mirbsd.org:$name:$eid</guid>
	EOF
	if [[ -n "${e_author[ent]}" ]]; then
		print "<author>${e_author[ent]}</author>\n"
	fi
	print "<description>"
	print -r -- "${e_body[ent]}" | mws_content | sed -e 's,<,\&lt;,g'
	cat <<-EOF
		</description>
		</item>
	EOF
}

print -r -- ${name}.rss
mws_setname $whoami "$pname"
mws_subdir 0
rss_putheader > ${name}.rss~

integer i='entries - 1'
integer last='entries < maxentries ? 0 : entries - maxentries'
while (( i >= last )); do
	eid=$(uri_escape "${e_id[i]}")
	rss_output $i $eid "/permalinks/" >> ${name}.rss~
	let i--
done

rss_putfooter >>${name}.rss~
mws_moveifchange ${name}.rss~ ${name}.rss
exit 0
